---
phase: 05-web-ui
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - ui/src/pages/Chains.tsx
  - ui/src/pages/Chains.module.css
  - ui/src/components/ChainEditor.tsx
  - ui/src/components/ChainEditor.module.css
  - ui/src/components/SortableEntry.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a list of all configured chains with their entry count"
    - "User can click a chain to open the chain editor showing its provider+model entries in order"
    - "User can drag entries to reorder them and the new order persists to backend"
    - "User can add a new entry (selecting provider and model) to a chain"
    - "User can remove an entry from a chain"
    - "User can create a new chain by name"
    - "User can delete a chain (non-default) with confirmation"
  artifacts:
    - path: "ui/src/pages/Chains.tsx"
      provides: "Chain list page with create/delete"
      min_lines: 50
    - path: "ui/src/components/ChainEditor.tsx"
      provides: "Chain entry editor with dnd-kit drag-and-drop reorder"
      min_lines: 80
    - path: "ui/src/components/SortableEntry.tsx"
      provides: "Individual draggable chain entry component"
      min_lines: 30
  key_links:
    - from: "ui/src/components/ChainEditor.tsx"
      to: "@dnd-kit/core"
      via: "DndContext with closestCenter collision detection"
      pattern: "DndContext"
    - from: "ui/src/components/ChainEditor.tsx"
      to: "/v1/admin/chains"
      via: "useMutation for PUT chain after reorder/add/remove"
      pattern: "useMutation.*putChain"
    - from: "ui/src/components/SortableEntry.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook for drag handle"
      pattern: "useSortable"
---

<objective>
Build the chain management page with drag-and-drop reordering of provider+model entries.

Purpose: Fulfills requirement WEBU-02 (Chain management -- create/edit/reorder provider+model pairs within chains). Users can visually reorder their waterfall chains, add/remove entries, and create new chains without editing YAML.

Output: Chains page, ChainEditor component with dnd-kit, and SortableEntry component.
</objective>

<execution_context>
@C:\Users\danen\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\danen\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-web-ui/05-01-SUMMARY.md
@.planning/phases/05-web-ui/05-02-SUMMARY.md
@.planning/phases/05-web-ui/05-RESEARCH.md

@ui/src/lib/api.ts
@ui/src/lib/queryKeys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chain list page with create/delete functionality</name>
  <files>
    ui/src/pages/Chains.tsx
    ui/src/pages/Chains.module.css
  </files>
  <action>
Replace the placeholder Chains page with a full implementation:

**ui/src/pages/Chains.tsx:**
- Use `useQuery` with `queryKeys.config` and `api.getConfig` to fetch chains and providers.
- Display chains as a list/table: chain name, number of entries, whether it's the default chain (badge/indicator).
- "Create Chain" button opens inline form: text input for chain name + submit/cancel. On submit, call `api.putChain(name, { entries: [] })` -- actually, a chain needs at least one entry. Instead, the create flow should:
  1. User enters chain name
  2. New chain appears in the list with 0 entries
  3. User clicks it to open ChainEditor and adds entries there

  BUT the backend validates `entries.min(1)`. So the create flow needs at least one entry. Solution: Create chain dialog asks for name AND first entry (provider + model dropdowns). Then submit with that initial entry.
- Each chain row has: name, entry count, "Edit" button, "Delete" button.
- Clicking a chain name or "Edit" opens the ChainEditor component for that chain (use `useState<string | null>(null)` to track which chain is being edited).
- Delete button: two-click confirmation (same pattern as Providers page). Cannot delete the default chain -- check against config and disable/hide delete for default chain.
- Delete calls `api.deleteChain(name)` with query invalidation on success.

**State management approach:**
- `selectedChain: string | null` -- which chain is open in editor
- `showCreateForm: boolean` -- whether the create chain form is visible
- The create form has: name input, provider select, model input, submit/cancel

The provider select dropdown is populated from the config query result (providers array).

**ui/src/pages/Chains.module.css:**
- Chain list: card-based layout
- Default chain: highlighted with accent color border
- Edit/Delete buttons: inline, small
- Create form: inline card at top of list
  </action>
  <verify>
Run `cd ui && npx tsc --noEmit` -- TypeScript compiles without errors.
  </verify>
  <done>
Chain list page displays all chains, supports creating chains with initial entry, deleting non-default chains with confirmation, and opening ChainEditor for selected chain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chain editor with dnd-kit drag-and-drop reorder</name>
  <files>
    ui/src/components/ChainEditor.tsx
    ui/src/components/ChainEditor.module.css
    ui/src/components/SortableEntry.tsx
  </files>
  <action>
**ui/src/components/ChainEditor.tsx:**
Props: `chainName: string`, `entries: Array<{ provider: string, model: string }>`, `providers: Array<{ id: string, name: string }>`, `onClose: () => void`.

Implementation:
- Maintain local entries state: `const [items, setItems] = useState(entries.map((e, i) => ({ ...e, id: String(i) })))`. Each entry needs a unique `id` for dnd-kit.
- Wrap entry list in `DndContext` from `@dnd-kit/core` with `closestCenter` collision detection.
- Inside DndContext, use `SortableContext` from `@dnd-kit/sortable` with `verticalListSortingStrategy`.
- Render each entry as a `<SortableEntry>` component.
- `onDragEnd` handler: use `arrayMove` from `@dnd-kit/sortable` to reorder items, update local state, then fire save mutation.

**Add Entry form** (inline at bottom of entry list):
- Provider select dropdown (populated from `providers` prop)
- Model text input
- "Add" button
- On add: append to local items, fire save mutation

**Remove Entry:**
- Each SortableEntry has a "Remove" button (X icon or text)
- On remove: filter out the entry from local items, fire save mutation
- Prevent removing last entry (entries.min(1) constraint)

**Save mutation:**
- `useMutation` calling `api.putChain(chainName, { entries: items.map(({ provider, model }) => ({ provider, model })) })`
- On success: `queryClient.invalidateQueries({ queryKey: queryKeys.config })`
- On error: display error message, revert local state to last known good

**Close button** at top to call `onClose` prop.

**ui/src/components/SortableEntry.tsx:**
- Use `useSortable` hook from `@dnd-kit/sortable` with item `id`.
- Apply `CSS.Transform.toString(transform)` and `transition` to the style.
- Render: drag handle icon (use unicode "&#x2630;" or ":::" text), provider name, model name, remove button.
- Spread `{...attributes, ...listeners}` on the drag handle element (not the whole row -- so users can still click remove button without triggering drag).

**ui/src/components/ChainEditor.module.css:**
- Entry row: flex layout, drag handle + provider + model + remove button
- Drag handle: cursor grab, distinct visual (dots or lines)
- Dragging state: slight elevation/shadow, background change
- Add entry form: compact row below entries
- Close button: top-right corner
- Container: card with border, max-width for readability
  </action>
  <verify>
Run `cd ui && npx tsc --noEmit` -- TypeScript compiles. Run `cd ui && npm run build` -- production build succeeds without errors.
  </verify>
  <done>
Chain editor displays entries in order, supports drag-and-drop reorder via dnd-kit, supports adding/removing entries with provider dropdown and model input, persists changes to backend via PUT chain mutation.
  </done>
</task>

</tasks>

<verification>
1. `cd ui && npm run build` succeeds
2. `cd ui && npx tsc --noEmit` passes
3. Chain list shows all chains from config
4. ChainEditor uses DndContext + SortableContext from dnd-kit
5. Drag-and-drop updates local state and fires PUT mutation
6. Add/remove entries update chain and persist
7. Default chain cannot be deleted
</verification>

<success_criteria>
- Chain list displays all chains with entry counts
- New chains can be created with a name and initial entry
- Chain editor shows entries in waterfall order
- Entries can be reordered by drag-and-drop (dnd-kit)
- Entries can be added (provider select + model input) and removed
- Changes persist to backend via PUT /v1/admin/chains/:name
- Default chain deletion is prevented
- Last entry cannot be removed (min 1 constraint)
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-ui/05-04-SUMMARY.md`
</output>
