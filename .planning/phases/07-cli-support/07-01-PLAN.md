---
phase: 07-cli-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.ts
  - package.json
  - .gitattributes
autonomous: true

must_haves:
  truths:
    - "429chain --help prints usage with --config, --port, --init, --help flags"
    - "429chain --init copies config.example.yaml to ./config/config.yaml in user's cwd"
    - "429chain sets CONFIG_PATH and PORT env vars then imports ./index.mjs"
    - "npm pack includes dist/, ui/dist/, config/config.example.yaml"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI entry point with shebang, arg parsing, init command, app bootstrap"
      contains: "#!/usr/bin/env node"
    - path: "package.json"
      provides: "bin, files, updated build scripts for CLI distribution"
      contains: "429chain"
    - path: ".gitattributes"
      provides: "LF line ending enforcement for CLI entry file"
      contains: "eol=lf"
  key_links:
    - from: "src/cli.ts"
      to: "./index.mjs"
      via: "dynamic import after setting env vars"
      pattern: "await import.*index"
    - from: "package.json bin"
      to: "dist/cli.mjs"
      via: "npm bin field"
      pattern: '"429chain".*"dist/cli.mjs"'
    - from: "src/cli.ts --init"
      to: "config/config.example.yaml"
      via: "import.meta.url path resolution + copyFileSync"
      pattern: "import\\.meta\\.url.*config\\.example"
---

<objective>
Create the CLI entry point and configure package.json for npm/npx distribution.

Purpose: This is the core CLI infrastructure -- the entry script that handles argument parsing, first-run initialization (--init), and delegates to the existing application bootstrap. Combined with package.json bin/files/scripts configuration, this makes 429chain installable and runnable as a CLI tool.

Output: src/cli.ts, updated package.json with bin/files/scripts, .gitattributes for line ending safety
</objective>

<execution_context>
@C:\Users\danen\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\danen\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cli-support/07-RESEARCH.md
@src/index.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point (src/cli.ts)</name>
  <files>src/cli.ts</files>
  <action>
Create `src/cli.ts` with the following:

1. **Shebang line** as the very first line: `#!/usr/bin/env node`

2. **Imports:** `parseArgs` from `node:util`, `existsSync`, `mkdirSync`, `copyFileSync` from `node:fs`, `fileURLToPath` from `node:url`, `dirname`, `join`, `resolve` from `node:path`.

3. **Argument parsing** using `util.parseArgs`:
   - `--config` / `-c`: type `'string'`, no default (resolved later)
   - `--port` / `-p`: type `'string'`
   - `--init`: type `'boolean'`
   - `--help` / `-h`: type `'boolean'`
   - Set `strict: false` to allow unknown args to pass through without error

4. **--help handler:** Print usage text and exit(0). Include:
   - Tool name and description: "429chain - OpenAI-compatible proxy with rate limit waterfall"
   - Usage line: `429chain [options]`
   - Options table: -c/--config, -p/--port, --init, -h/--help with descriptions
   - Examples: `429chain`, `429chain --config /etc/429chain.yaml`, `429chain --init`, `npx 429chain`

5. **--init handler:**
   - Determine target path: `resolve(process.cwd(), 'config', 'config.yaml')`
   - Determine source path using `import.meta.url`: `join(dirname(fileURLToPath(import.meta.url)), '..', 'config', 'config.example.yaml')`
   - If target already exists, print error "Config file already exists at {path}" and exit(1)
   - If source example doesn't exist, print error "Example config not found (package may be corrupted)" and exit(1)
   - Create target directory with `mkdirSync(targetDir, { recursive: true })`
   - Copy with `copyFileSync(sourcePath, targetPath)`
   - Print success message with next steps: edit config, then run `429chain`
   - Exit(0)

6. **Set environment variables** for the existing app:
   - If `values.config` is set: `process.env.CONFIG_PATH = values.config`
   - If `values.port` is set: `process.env.PORT = values.port`

7. **Bootstrap the application:** `await import('./index.mjs');`
   - IMPORTANT: Use `'./index.mjs'` (the built output filename), NOT `'./index.js'` or `'./index.ts'`
   - This is a dynamic import at the end of the file, after env vars are set

Do NOT add any external dependencies. Use only Node.js built-in modules.
  </action>
  <verify>
Run `npx tsx src/cli.ts --help` and verify it prints usage text with all four flags documented. Should exit cleanly with code 0.
  </verify>
  <done>src/cli.ts exists with shebang, parseArgs for --config/--port/--init/--help, init handler using import.meta.url for asset resolution, env var pass-through, and dynamic import of ./index.mjs</done>
</task>

<task type="auto">
  <name>Task 2: Configure package.json for CLI distribution</name>
  <files>package.json, .gitattributes</files>
  <action>
Update `package.json` with these changes:

1. **Update `main` field:** Change from `"dist/index.js"` to `"dist/index.mjs"` (matches actual tsdown output)

2. **Add `bin` field:**
   ```json
   "bin": {
     "429chain": "dist/cli.mjs"
   }
   ```

3. **Add `files` field** (whitelist for npm publish):
   ```json
   "files": [
     "dist/",
     "ui/dist/",
     "config/config.example.yaml"
   ]
   ```

4. **Update `scripts`:**
   - Change `"build"` to: `"npm run build:backend && npm run build:ui"`
   - Add `"build:backend"`: `"tsdown src/cli.ts src/index.ts --format esm --dts"`
   - Add `"build:ui"`: `"cd ui && npm run build"`
   - Change `"start"` to: `"node dist/index.mjs"` (was `dist/index.js`)
   - Add `"prepublishOnly"`: `"npm test && npm run build"`
   - Keep `"dev"`, `"test"`, `"test:watch"`, `"typecheck"` unchanged

5. **Keep existing fields** unchanged: name, version, type, description, engines, keywords, author, license, dependencies, devDependencies.

6. **Add `"cli"` to keywords array** for discoverability.

Create `.gitattributes` at project root to enforce LF line endings on the CLI entry file (prevents shebang CRLF issues on Windows):
```
# Ensure CLI entry point has LF line endings for shebang compatibility
dist/cli.mjs text eol=lf
```

Do NOT remove any existing dependencies or scripts. This is additive.
  </action>
  <verify>
Run `node -e "const p = require('./package.json'); console.log(p.bin, p.files, p.scripts.build, p.scripts['build:backend'])"` and verify bin points to dist/cli.mjs, files includes dist/ and ui/dist/ and config/config.example.yaml, build chains backend+ui, build:backend includes both entry points.
  </verify>
  <done>package.json has bin field mapping "429chain" to "dist/cli.mjs", files whitelist includes dist/ + ui/dist/ + config/config.example.yaml, build scripts split into build:backend (both entries) and build:ui, prepublishOnly runs test+build, main points to dist/index.mjs. .gitattributes enforces LF on dist/cli.mjs.</done>
</task>

</tasks>

<verification>
1. `npx tsx src/cli.ts --help` prints usage and exits 0
2. `npx tsx src/cli.ts --init` creates ./config/config.yaml (remove test artifact after)
3. package.json `bin` field maps "429chain" to "dist/cli.mjs"
4. package.json `files` includes all three required entries
5. package.json `build:backend` script includes both src/cli.ts and src/index.ts
6. .gitattributes exists with LF enforcement for dist/cli.mjs
</verification>

<success_criteria>
- src/cli.ts has shebang line, parseArgs with all four flags, --init handler using import.meta.url, env var pass-through, and dynamic import of ./index.mjs
- package.json configured for CLI distribution (bin, files, build scripts, prepublishOnly)
- .gitattributes prevents CRLF shebang issues
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-support/07-01-SUMMARY.md`
</output>
