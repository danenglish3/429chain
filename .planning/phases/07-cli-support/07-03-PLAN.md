---
phase: 07-cli-support
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "npm run build:backend succeeds and produces dist/cli.mjs with shebang"
    - "npm run build:ui succeeds and produces ui/dist/index.html"
    - "npm run build (combined) succeeds end-to-end"
    - "dist/cli.mjs --help prints usage text"
    - "npm pack produces tarball containing dist/, ui/dist/, and config/config.example.yaml"
    - "User verifies npx 429chain --init and npx 429chain work correctly"
  artifacts:
    - path: "dist/cli.mjs"
      provides: "Built CLI entry point with shebang"
      contains: "#!/usr/bin/env node"
    - path: "dist/index.mjs"
      provides: "Built application entry point"
  key_links:
    - from: "dist/cli.mjs"
      to: "dist/index.mjs"
      via: "dynamic import('./index.mjs')"
      pattern: "import.*index"
    - from: "dist/cli.mjs --init"
      to: "config/config.example.yaml"
      via: "import.meta.url path resolution"
      pattern: "config.example"
---

<objective>
Build, verify, and validate the complete CLI pipeline end-to-end.

Purpose: Plans 01 and 02 created the source files. This plan builds everything, verifies the build output is correct, checks that npm pack includes all required files, and has the user do a final hands-on verification of the CLI experience.

Output: Verified build output, validated npm pack contents, human-verified CLI workflow
</objective>

<execution_context>
@C:\Users\danen\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\danen\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cli-support/07-RESEARCH.md
@.planning/phases/07-cli-support/07-01-SUMMARY.md
@.planning/phases/07-cli-support/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build and verify CLI pipeline</name>
  <files></files>
  <action>
Run the full build pipeline and verify all outputs are correct.

1. **Run the backend build:**
   ```bash
   npm run build:backend
   ```
   Verify:
   - `dist/cli.mjs` exists and starts with `#!/usr/bin/env node`
   - `dist/index.mjs` exists
   - Both files are valid ESM (contain `import` statements)

2. **Run the UI build:**
   ```bash
   npm run build:ui
   ```
   Verify:
   - `ui/dist/index.html` exists
   - `ui/dist/assets/` directory exists with JS/CSS files

3. **Run the combined build:**
   ```bash
   npm run build
   ```
   Verify both outputs still exist and are fresh.

4. **Test the built CLI help:**
   ```bash
   node dist/cli.mjs --help
   ```
   Verify it prints usage text with --config, --port, --init, --help documented.

5. **Test npm pack contents:**
   ```bash
   npm pack --dry-run
   ```
   Verify the output lists:
   - `dist/cli.mjs` (and other dist/ files)
   - `ui/dist/index.html` (and other ui/dist/ files)
   - `config/config.example.yaml`
   - `package.json`
   Verify NO unwanted files: no `src/`, no `node_modules/`, no `.planning/`

6. **Test --init with built CLI:**
   ```bash
   mkdir -p /tmp/429chain-test && cd /tmp/429chain-test && node {project_root}/dist/cli.mjs --init
   ```
   Verify:
   - `config/config.yaml` created in test directory
   - File contents match config.example.yaml
   - Clean up test directory after

7. **Run existing tests** to confirm no regressions:
   ```bash
   npm test
   ```

8. **Run typecheck:**
   ```bash
   npm run typecheck
   ```

If any step fails, diagnose and fix the issue. Common problems:
- tsdown not recognizing multiple entry points: check that the command is `tsdown src/cli.ts src/index.ts --format esm --dts`
- Shebang stripped by bundler: tsdown preserves shebangs by default, but verify in output
- import.meta.url not working in built output: tsdown preserves import.meta.url in ESM output
  </action>
  <verify>
All 8 checks pass: build:backend produces dist/cli.mjs with shebang + dist/index.mjs, build:ui produces ui/dist/, combined build succeeds, --help works, npm pack shows correct file list, --init creates config, npm test passes, typecheck passes.
  </verify>
  <done>Full build pipeline produces correct CLI distribution: dist/cli.mjs (with shebang), dist/index.mjs, ui/dist/ assets, config/config.example.yaml all included in npm pack output. Tests and typecheck pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CLI support for 429chain: install and run via npx/npm with --help, --init, --config, --port flags, import.meta.url static file serving, graceful missing-config error</what-built>
  <how-to-verify>
1. Run `node dist/cli.mjs --help` -- should print usage with all flags
2. Create a test directory and run `node dist/cli.mjs --init` from it -- should create config/config.yaml
3. Edit the created config with real provider credentials, then run `node dist/cli.mjs --config ./config/config.yaml` -- proxy should start and UI should be accessible at http://localhost:3429
4. Try running without config (from empty dir): `node dist/cli.mjs` -- should show friendly error with --init hint
5. Run with port override: `node dist/cli.mjs --config ./config/config.yaml --port 4000` -- should start on port 4000
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds end-to-end (backend + UI)
2. `dist/cli.mjs` contains shebang and valid ESM code
3. `node dist/cli.mjs --help` prints usage
4. `npm pack --dry-run` shows correct file list
5. Human verified: --init, --config, --port, missing-config error all work
6. `npm test` passes (no regressions)
</verification>

<success_criteria>
- Full build pipeline works: build:backend + build:ui + combined build
- CLI is functional: --help, --init, --config, --port all work correctly
- npm pack includes all required files for distribution
- No test regressions
- Human approves CLI experience
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-support/07-03-SUMMARY.md`
</output>
