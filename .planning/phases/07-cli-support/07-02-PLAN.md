---
phase: 07-cli-support
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/config/loader.ts
autonomous: true

must_haves:
  truths:
    - "Static UI assets serve correctly when running from global install (not just cwd)"
    - "Missing config file shows helpful error with --init hint instead of crashing with ENOENT"
    - "Config resolution priority is: CLI args > env vars > default"
  artifacts:
    - path: "src/index.ts"
      provides: "import.meta.url-based static file path resolution"
      contains: "import.meta.url"
    - path: "src/config/loader.ts"
      provides: "Graceful config-not-found error with init hint"
      contains: "429chain --init"
  key_links:
    - from: "src/index.ts"
      to: "ui/dist/"
      via: "import.meta.url + fileURLToPath + dirname + join for absolute path"
      pattern: "fileURLToPath.*import\\.meta\\.url"
    - from: "src/config/loader.ts"
      to: "process.exit"
      via: "existsSync check before readFileSync"
      pattern: "existsSync.*429chain --init"
---

<objective>
Update application entry point and config loader for CLI compatibility.

Purpose: The existing code uses relative paths (`./ui/dist`) for static file serving and crashes with an unhelpful ENOENT when config is missing. Both must be fixed for CLI distribution: static paths must resolve relative to the package installation (not cwd), and missing config must show a helpful "run --init" message.

Output: Updated src/index.ts with import.meta.url path resolution, updated src/config/loader.ts with graceful missing-config handling
</objective>

<execution_context>
@C:\Users\danen\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\danen\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cli-support/07-RESEARCH.md
@src/index.ts
@src/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update static file serving to use import.meta.url</name>
  <files>src/index.ts</files>
  <action>
Update `src/index.ts` to resolve static file paths using `import.meta.url` instead of relative paths. This ensures UI assets are found when the package is installed globally (where cwd is NOT the package directory).

1. **Add imports** at the top (after existing imports):
   ```typescript
   import { fileURLToPath } from 'node:url';
   import { dirname, join } from 'node:path';
   ```

2. **Add path resolution** near the top of the bootstrap section (after imports, before any usage):
   ```typescript
   const __filename = fileURLToPath(import.meta.url);
   const __dirname = dirname(__filename);
   const UI_DIST_PATH = join(__dirname, '..', 'ui', 'dist');
   ```
   The `..` is needed because `__dirname` will be `dist/` (where index.mjs lives), and `ui/dist/` is a sibling directory to `dist/`.

3. **Update the three serveStatic calls** to use absolute paths with `UI_DIST_PATH`:

   Replace `serveStatic({ root: './ui/dist' })` with:
   ```typescript
   serveStatic({ root: UI_DIST_PATH })
   ```

   Replace `serveStatic({ path: './ui/dist/vite.svg' })` with:
   ```typescript
   serveStatic({ path: join(UI_DIST_PATH, 'vite.svg') })
   ```

   Replace `serveStatic({ path: './ui/dist/index.html' })` with:
   ```typescript
   serveStatic({ path: join(UI_DIST_PATH, 'index.html') })
   ```

4. **Do NOT change anything else** in index.ts. Keep all existing imports, bootstrap logic, route mounting, server startup, and shutdown handler exactly as they are.

Important: Verify that `@hono/node-server/serve-static`'s `root` option accepts an absolute path. Based on research and Hono docs, it does -- `root` is passed to `node:path.resolve()` internally.
  </action>
  <verify>
Run `npx tsx -e "import { fileURLToPath } from 'node:url'; import { dirname, join } from 'node:path'; const f = fileURLToPath(import.meta.url); const d = dirname(f); console.log(join(d, '..', 'ui', 'dist'));"` to verify the path resolution pattern works. Then run `npm run typecheck` to verify no type errors in the modified index.ts.
  </verify>
  <done>src/index.ts uses import.meta.url + fileURLToPath + dirname + join to compute UI_DIST_PATH as an absolute path, and all three serveStatic calls use this absolute path instead of relative './ui/dist'.</done>
</task>

<task type="auto">
  <name>Task 2: Add graceful missing-config handling with init hint</name>
  <files>src/config/loader.ts</files>
  <action>
Update `src/config/loader.ts` to detect missing config files before attempting to read them, and show a helpful error message directing users to run `429chain --init`.

1. **Add import** at the top:
   ```typescript
   import { existsSync } from 'node:fs';
   ```
   Note: `readFileSync` is already imported from `node:fs`, so add `existsSync` to the existing import.

2. **Add missing-file check** as the FIRST thing in `loadConfig()`, before the existing try/catch for readFileSync:
   ```typescript
   if (!existsSync(path)) {
     console.error(`\nConfig file not found: ${path}\n`);
     console.error('To create a config file, run:');
     console.error('  429chain --init\n');
     console.error('Or specify a custom config path:');
     console.error('  429chain --config /path/to/config.yaml\n');
     process.exit(1);
   }
   ```
   Use `console.error` (not logger) because the user may not have pino configured yet, and the error message should always be visible regardless of log level or format.

3. **Keep the existing error handling** intact. The readFileSync try/catch still handles permission errors, IO errors, etc. The new check only handles the "file doesn't exist" case with a user-friendly message instead of a raw ENOENT stack trace.

4. **Do NOT change** `resolveConfigPath()` -- the CLI entry point (cli.ts) will handle --config by setting `process.env.CONFIG_PATH`, which resolveConfigPath already checks.
  </action>
  <verify>
Run `npx tsx -e "import { loadConfig } from './src/config/loader.js'; loadConfig('/nonexistent/path.yaml');" 2>&1` and verify the output shows the friendly error message with "429chain --init" hint (not a raw ENOENT stack trace). Expected: process exits with code 1 and the hint message is printed.
  </verify>
  <done>src/config/loader.ts checks existsSync(path) before attempting readFileSync, and prints a user-friendly error with "429chain --init" hint when the config file is missing, then exits with code 1.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors on modified files
2. Existing tests still pass: `npm test`
3. Static file serving code uses `import.meta.url` derived absolute path (not relative `./ui/dist`)
4. Missing config produces friendly error with `--init` hint
</verification>

<success_criteria>
- src/index.ts resolves UI_DIST_PATH from import.meta.url and uses it in all three serveStatic calls
- src/config/loader.ts shows friendly "run 429chain --init" error when config file is missing
- Existing functionality unchanged: typecheck and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-support/07-02-SUMMARY.md`
</output>
